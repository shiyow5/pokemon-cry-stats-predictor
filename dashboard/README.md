# ポケモン鳴き声ステータス予測ダッシュボード 🎮

ポケモンの鳴き声から抽出した音声特徴量を使ってステータスを予測する機械学習モデルの学習、評価、使用のためのインタラクティブなStreamlitダッシュボードです。

## 📋 目次

- [機能](#機能)
- [インストール](#インストール)
- [使い方](#使い方)
- [ダッシュボードのタブ](#ダッシュボードのタブ)
- [プロジェクト構造](#プロジェクト構造)
- [技術詳細](#技術詳細)
- [トラブルシューティング](#トラブルシューティング)

## ✨ 機能

### 📊 モデル評価タブ
- 学習済みモデルのパフォーマンス指標を表示
- インタラクティブなR²比較チャート
- ステータスごとのパフォーマンスを示すヒートマップ
- クロスバリデーション結果の可視化
- 評価結果をJSONでダウンロード

### 🎤 予測タブ
- **2つの入力方法:**
  - 音声ファイルのアップロード（OGG、WAV、MP3）
  - ブラウザでマイクを使った直接録音
- 音声からリアルタイムでステータス予測
- 音声特徴量の類似度に基づく類似ポケモンの検索
- PokeAPIからのポケモン画像表示
- 類似ポケモンの実際のステータスと予測の比較

### 🏋️ 学習タブ
- 3種類のモデルを学習（個別または全て）:
  - ニューラルネットワーク（最高性能）
  - ランダムフォレスト
  - XGBoost
  - 全モデル（3つのモデルを一括学習）
- 各モデルのハイパーパラメータ設定
- 学習/テストデータの分割比率調整
- リアルタイムの学習進捗表示
- モデルの自動保存

### 📁 データ管理タブ
- **データセットの可視化:**
  - 全ポケモンをカード形式で表示
  - PokeAPIから取得した公式アートワーク
  - 図鑑番号、名前、全6ステータス（HP、攻撃、防御、素早さ、特攻、特防）
- **検索機能:**
  - 名前または図鑑番号でフィルタリング
  - リアルタイム検索結果表示
- **削除機能:**
  - 確認ダイアログ付き安全な削除
  - CSV、音声ファイルを自動削除
- **追加機能:**
  - PokeAPIから新しいポケモンを取得
  - 図鑑番号または名前で追加可能
  - 自動的にステータスと音声をダウンロード

## 🚀 インストール

### 前提条件

1. **Python 3.8+** と仮想環境
2. **必要なデータファイル**（親プロジェクトから生成）:
   - `data/audio_features_advanced.csv`
   - `data/raw_stats.csv`
   - `data/cries/*.ogg`（音声ファイル）

### セットアップ

1. **仮想環境を有効化:**

```bash
# プロジェクトルートから
source .venv/bin/activate  # Linux/macOS
# または
.venv\Scripts\activate  # Windows
```

2. **ダッシュボードの依存関係をインストール:**

```bash
pip install -r requirements.txt
```

以下のパッケージがインストールされます:
- `streamlit>=1.28.0` - ダッシュボードフレームワーク
- `audio-recorder-streamlit>=0.0.8` - マイク録音
- `plotly>=5.17.0` - インタラクティブチャート
- `scipy>=1.11.0` - 類似度計算
- その他標準的なMLライブラリ（numpy、pandas、scikit-learn、tensorflow、xgboost）

3. **データが利用可能か確認:**

データファイルが存在しない場合、準備スクリプトを実行してください:

```bash
# プロジェクトルートから
python scripts/fetch_stats.py
python scripts/download_cries.py
python scripts/extract_audio_features_advanced.py
```

4. **初期モデルの学習（オプションですが推奨）:**

```bash
python scripts/train_model_advanced.py
```

## 📱 使い方

### ダッシュボードの起動

プロジェクトルートディレクトリから:

```bash
streamlit run dashboard/app.py
```

ダッシュボードはブラウザで自動的に `http://localhost:8501` で開きます。

### 基本的なワークフロー

1. **初回セットアップ:**
   - **学習**タブに移動
   - モデルを選択（ニューラルネットワーク推奨）
   - 「学習開始」をクリック
   - 学習完了まで待機（2〜5分）

2. **モデルの評価:**
   - **モデル評価**タブに移動
   - パフォーマンス指標とチャートを確認
   - 異なるモデルを比較

3. **予測の実行:**
   - **予測**タブに移動
   - ポケモンの鳴き声音声ファイルをアップロード または
   - マイクボタンをクリックして音声を録音
   - 「ステータス予測」をクリック
   - 予測されたステータスと類似ポケモンを表示

## 📑 ダッシュボードのタブ

### 📊 モデル評価

**目的:** 学習済みモデルの分析と比較

**機能:**
- モデル間の全体的なR²スコア比較
- ステータスごとのパフォーマンスヒートマップ（HP、攻撃、防御など）
- 平均値と標準偏差を含むクロスバリデーション結果
- 詳細な指標テーブル
- 生データのダウンロードボタン

**使用タイミング:** モデル学習後、パフォーマンスを評価し最適なモデルを選択する際

---

### 🎤 予測

**目的:** 音声からポケモンステータスを予測

**機能:**
- **ファイルアップロード:** 音声ファイルをドラッグ&ドロップまたは選択
- **マイク録音:** ブラウザ内で音声を録音
- **特徴量抽出:** 自動的に59次元の特徴量を抽出
- **ステータス予測:** 6つの予測ステータスすべてを表示
- **類似ポケモン:** 最も類似した上位3体のポケモンを表示:
  - PokeAPIからのポケモン画像
  - ユークリッド距離スコア
  - 比較用の実際のステータス
- **比較テーブル:** 予測値と実際の値を並べて表示

**使用タイミング:** 新しいまたはカスタムのポケモン鳴き声のステータスを予測する際

**ヒント:**
- 最良の結果を得るには、ポケモンの発声に似た音声を使用してください
- 2〜3秒の長めの音声サンプルがより良い結果を生みます
- 録音は静かな環境で行うのが最適です

---

### 🏋️ 学習

**目的:** カスタムパラメータで新しいモデルを学習

**機能:**

**モデルタイプ:**
1. **ニューラルネットワーク**（推奨）
   - 隠れ層の設定
   - エポック数、バッチサイズ、学習率
   - ドロップアウト率、早期停止の忍耐値

2. **ランダムフォレスト**
   - 木の数
   - 最大深さ、最小分割サンプル数/葉サンプル数

3. **XGBoost**
   - ブースティングラウンド数
   - 最大深さ、学習率
   - サブサンプル比率と特徴量サンプリング比率

4. **全モデル**
   - 3つのモデル全てをデフォルトパラメータで学習
   - 一度に複数モデルを比較したい場合に便利
   - 学習時間: 5〜8分

**学習設定:**
- テストセットサイズ（0.1〜0.4）
- 再現性のためのランダムシード

**学習プロセス:**
- 「学習開始」をクリック
- リアルタイムで進捗をモニター
- 学習ログ出力を表示
- モデルは自動的に `models/` ディレクトリに保存

**使用タイミング:**
- 初めてモデルを学習する際
- 異なるハイパーパラメータで実験する際
- 新しいデータを追加した後に再学習する際

---

### 📁 データ管理

**目的:** トレーニングデータセットの管理と編集

**機能:**

**データセット表示:**
- 全ポケモンを3列グリッドレイアウトでカード表示
- 各カードに以下を表示:
  - PokeAPIから取得した公式アートワーク（150x150px）
  - 図鑑番号と名前（例: #025 - Pikachu）
  - 6つの基礎ステータス（HP、攻撃、防御、素早さ、特攻、特防）
  - 削除ボタン

**検索・フィルタリング:**
- リアルタイムテキスト検索
- ポケモン名で検索（部分一致対応）
- 図鑑番号で検索
- 検索結果の件数表示（例: "Showing 3 of 1092 Pokémon"）

**ポケモンの削除:**
1. カードの削除ボタンをクリック
2. 確認ダイアログが表示（「✅ Confirm」または「❌ Cancel」）
3. 確認後、以下のファイルから自動削除:
   - `data/raw_stats.csv`
   - `data/audio_features_advanced.csv`（該当行）
   - `data/cries/{name}.ogg`（音声ファイル）
4. 成功時にバルーンアニメーション表示

**ポケモンの追加:**
1. 「Add New Pokémon」エキスパンダーを展開
2. ポケモン名または図鑑番号を入力（例: "mewtwo" または "150"）
3. 「➕ Add」ボタンをクリック
4. システムが以下を自動実行:
   - PokeAPIからポケモンデータを取得
   - `data/raw_stats.csv`に新しい行を追加
   - 音声ファイル（.ogg）をダウンロード（利用可能な場合）
   - 成功メッセージと次のステップを表示

**使用タイミング:**
- データセットの内容を確認したい時
- 特定のポケモンをデータセットから削除したい時
- 新しいポケモンをトレーニングデータに追加したい時
- データセット変更後は再学習が必要

**重要な注意事項:**
- 削除操作は元に戻せません（CSV変更前のバックアップ推奨）
- ポケモン追加後は `python scripts/extract_audio_features_advanced.py` を実行して音声特徴量を抽出する必要があります
- データセット変更後、既存のモデルを再学習することを推奨

## 📂 プロジェクト構造

```
dashboard/
├── app.py                 # Streamlitアプリケーションのメインエントリーポイント
├── tabs/                  # タブの実装
│   ├── evaluation.py     # モデル評価タブ
│   ├── predict.py        # 予測タブ
│   ├── train.py          # 学習タブ
│   └── data_management.py # データ管理タブ（NEW）
├── utils/                # ユーティリティ関数
│   ├── audio_processor.py    # 音声特徴量抽出
│   ├── model_loader.py       # モデル読み込みユーティリティ
│   └── similarity.py         # ポケモン類似度検索
└── README.md             # このファイル
```

### 主要ファイル

- **app.py**: メインエントリーポイント、タブ構造を作成
- **tabs/evaluation.py**: モデル結果の読み込み、チャート作成
- **tabs/predict.py**: 音声入力、予測、類似度検索の処理
- **tabs/train.py**: モデル設定、学習実行
- **tabs/data_management.py**: データセット管理（表示、検索、削除、追加）
- **utils/audio_processor.py**: 音声バイトから59次元特徴量を抽出
- **utils/model_loader.py**: モデルとスケーラーの読み込み
- **utils/similarity.py**: ユークリッド距離を使用した類似ポケモンの検索

## 🔧 技術詳細

### 音声特徴量抽出（59次元）

システムは包括的な音声特徴量を抽出します:

| 特徴タイプ | 次元数 | 説明 |
|--------------|------------|-------------|
| MFCC | 26 | メル周波数ケプストラム係数の平均(13) + 標準偏差(13) |
| スペクトル | 3 | ゼロ交差率、スペクトル重心、ロールオフ |
| クロマ | 12 | ピッチクラス特徴量 |
| スペクトルコントラスト | 7 | スペクトルピーク-バレー差分 |
| Tonnetz | 6 | 調性重心特徴量 |
| テンポ | 1 | 1分あたりのビート数 |
| 追加スペクトル | 4 | 帯域幅、平坦度、RMS平均/標準偏差 |

**合計: 59特徴量**

### モデルアーキテクチャ

#### ニューラルネットワーク（デフォルト）
```
入力(59) → Dense(128, ReLU) → Dropout(0.2)
→ Dense(64, ReLU) → Dropout(0.2)
→ Dense(32, ReLU) → 出力(6)

オプティマイザ: Adam (lr=0.001)
損失関数: MSE
エポック: 200（早期停止付き）
```

#### ランダムフォレスト
```
100本の決定木のアンサンブル
最大深さ: 20
最小分割サンプル数: 2
マルチ出力回帰
```

#### XGBoost
```
100ラウンドの勾配ブースティング
最大深さ: 6
学習率: 0.1
サブサンプル: 0.8
```

### 類似度検索

ポケモンの類似度は以下の方法で計算されます:
1. 入力音声から特徴量を抽出
2. データセット内のすべてのポケモンの特徴量を読み込み
3. 各ポケモンとのユークリッド距離を計算
4. 距離でソート（小さいほど類似）
5. 上位k件の最も類似したポケモンを返す

**距離の公式:**
```
distance = √(Σ(feature_i - pokemon_feature_i)²)
```

### モデルの保存

学習済みモデルは `models/` ディレクトリに保存されます:

- **ニューラルネットワーク:** `pokemon_stats_nn.keras` + `scaler.joblib`
- **ランダムフォレスト:** `pokemon_stats_rf.joblib` + `scaler_rf.joblib`
- **XGBoost:** `pokemon_stats_xgb.joblib` + `scaler_xgb.joblib`

結果は `results/model_comparison_TIMESTAMP.json` に保存されます。

## 🐛 トラブルシューティング

### ダッシュボードが起動しない

**問題:** `streamlit: command not found`

**解決方法:**
```bash
source .venv/bin/activate
pip install streamlit
```

---

### モデルが見つからない

**問題:** 予測タブで「Model file not found」エラー

**解決方法:**
1. 学習タブに移動
2. 少なくとも1つのモデルを学習（ニューラルネットワーク推奨）
3. 学習が完了するまで待機
4. 予測タブに戻る

---

### マイクが動作しない

**問題:** マイクボタンをクリックしても音声が録音されない

**解決方法:**
1. ブラウザにマイクの許可があることを確認
2. `audio-recorder-streamlit` がインストールされていることを確認:
   ```bash
   pip install audio-recorder-streamlit
   ```
3. 代わりにファイルアップロードを使用
4. ChromeまたはFirefoxを使用（最良の互換性）

---

### PokeAPIの画像が読み込まれない

**問題:** 予測タブでポケモン画像が表示されない

**解決方法:**
1. インターネット接続を確認（APIアクセスが必要）
2. ポケモン名はPokeAPIフォーマット（小文字、ハイフン区切り）に一致する必要があります
3. 一部の特殊文字は問題を引き起こす可能性があります
4. APIが一時的に利用できない可能性（後で再試行）

---

### 学習に時間がかかりすぎる

**問題:** 学習が停止しているか、非常に遅い

**解決方法:**
1. ニューラルネットワークの学習は通常2〜5分かかります
2. 学習タブでエポック数を減らす
3. ランダムフォレスト/XGBoostの木/ラウンド数を減らす
4. ターミナルでエラーメッセージを確認
5. データセットが大きすぎないことを確認（100サンプルが標準）

---

### 特徴量抽出が失敗する

**問題:** 予測タブで音声処理中にエラー

**解決方法:**
1. 音声ファイルが有効（OGG、WAV、またはMP3）であることを確認
2. librosaがインストールされていることを確認: `pip install librosa`
3. より短い音声ファイル（< 10秒）を試す
4. 音声が破損していないことを確認
5. サンプルレートがサポートされていることを確認（デフォルト22050 Hz）

---

### インポートエラー

**問題:** ダッシュボード起動時に `ModuleNotFoundError`

**解決方法:**
```bash
# すべての要件を再インストール
pip install -r requirements.txt

# 特定のパッケージが不足している場合:
pip install streamlit plotly audio-recorder-streamlit scipy
```

---

### データファイルが見つからない

**問題:** 学習タブで「Required data files are missing」

**解決方法:**
```bash
# データ準備パイプラインを実行
python scripts/fetch_stats.py
python scripts/download_cries.py
python scripts/extract_audio_features_advanced.py
```

---

### ポートがすでに使用中

**問題:** 「Address already in use」エラー

**解決方法:**
```bash
# 別のポートを使用
streamlit run dashboard/app.py --server.port 8502

# または既存のStreamlitプロセスを終了
pkill -f streamlit
```

## 📊 期待されるパフォーマンス

現在のデータセット（100匹のポケモン）に基づく:

| モデル | 全体R² | 学習時間 | 予測時間 |
|-------|-----------|---------------|-----------------|
| ニューラルネットワーク | ~0.116 | 2〜5分 | < 1秒 |
| ランダムフォレスト | ~0.076 | 1〜2分 | < 1秒 |
| XGBoost | ~-0.033 | 1〜2分 | < 1秒 |

**注意:** ニューラルネットワークは最高性能のモデルで、予測に推奨されます。

## 🎯 最良の結果を得るためのヒント

1. **学習:**
   - 最高のパフォーマンスにはニューラルネットワークを使用
   - 信頼性の高い評価のためにテストサイズは0.2に保つ
   - 過学習を防ぐために早期停止を使用
   - 安定性を評価するため、異なるシードで複数回学習

2. **予測:**
   - クリアで高品質な音声録音を使用
   - 2〜3秒の音声長が最適
   - ポケモンのような発声が最も良い結果を生む
   - 類似ポケモンで予測を検証

3. **モデル比較:**
   - 全体だけでなく、ステータスごとのR²スコアを確認
   - 一部のステータス（HP、特攻）は他より予測しやすい
   - R²とRMSEの両方の指標を考慮
   - クロスバリデーションスコアはモデルの安定性を示す

## 📚 追加リソース

- **親プロジェクトREADME:** `../README.md`
- **ExecPlan:** `../.agent/streamlit_dashboard_execplan.md`
- **学習スクリプト:** `../scripts/train_model_advanced.py`
- **PokeAPIドキュメント:** https://pokeapi.co/docs/v2
- **Streamlitドキュメント:** https://docs.streamlit.io

## 🤝 貢献

ダッシュボードを拡張するには:

1. `tabs/` ディレクトリに新しいタブを追加
2. `utils/` に新しいユーティリティ関数を作成
3. 新しいタブを含めるように `app.py` を更新
4. 新機能でこのREADMEを更新

## 📝 ライセンス

PokémonCryMLプロジェクトの一部です。ライセンス情報については親ディレクトリを参照してください。

---

**楽しく予測してください！ 🎮✨**
